{{- if and .Values.autoscaling.enabled (eq .Values.autoscaling.type "hpa") }}
# =============================================================================
# HorizontalPodAutoscaler - Standard CPU/Memory-based Scaling
# =============================================================================
# This HPA is created when autoscaling.type is set to "hpa".
# For queue-based scaling with KEDA, set autoscaling.type: "keda"
# =============================================================================
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "densecore.fullname" . }}-hpa
  labels:
    {{- include "densecore.labels" . | nindent 4 }}
    app.kubernetes.io/component: autoscaling
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "densecore.fullname" . }}
  
  minReplicas: {{ .Values.autoscaling.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.maxReplicas }}
  
  metrics:
    # Scale based on CPU utilization
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.hpa.cpuTargetUtilization }}
    # Scale based on Memory utilization
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.autoscaling.hpa.memoryTargetUtilization }}
  
  behavior:
    scaleDown:
      # Prevent flapping by waiting before scale-down
      stabilizationWindowSeconds: {{ .Values.autoscaling.hpa.scaleDownStabilizationSeconds }}
      policies:
        - type: Percent
          value: {{ .Values.autoscaling.hpa.scaleDownPercentPerMinute }}
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: {{ .Values.autoscaling.hpa.scaleUpStabilizationSeconds }}
      policies:
        - type: Percent
          value: 100
          periodSeconds: 15
        - type: Pods
          value: {{ .Values.autoscaling.hpa.scaleUpMaxPods }}
          periodSeconds: 15
      selectPolicy: Max
{{- end }}

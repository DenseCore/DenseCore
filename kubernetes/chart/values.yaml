# =============================================================================
# DenseCore Helm Chart Values
# =============================================================================
# Default configuration values for DenseCore deployment.
# Override these values by providing a custom values.yaml file:
#   helm install densecore ./chart -f custom-values.yaml
# =============================================================================

# =============================================================================
# Image Configuration
# =============================================================================
image:
  repository: densecore
  tag: latest
  pullPolicy: Always

downloaderImage:
  repository: densecore/downloader
  tag: latest
  pullPolicy: IfNotPresent

# =============================================================================
# Replica Configuration (used when autoscaling is disabled)
# =============================================================================
replicaCount: 1

# =============================================================================
# Model Configuration
# =============================================================================
model:
  # Hugging Face repository ID
  repo: "Qwen/Qwen2.5-0.5B-Instruct-GGUF"
  # Model filename within the repository
  file: "qwen2.5-0.5b-instruct-q4_k_m.gguf"
  # Path where the model is mounted inside the container
  path: "/models/main_model.gguf"

# =============================================================================
# Persistence Configuration
# =============================================================================
# Choose storage strategy for model files:
#   type: "emptyDir"  - Ephemeral, re-downloads on pod restart (default)
#   type: "pvc"       - Persistent Volume Claim (recommended for production)
#   type: "hostPath"  - Node-local cache (fastest, but node-specific)
# =============================================================================
persistence:
  # Storage type: "emptyDir", "pvc", or "hostPath"
  type: "emptyDir"

  # --------------------------------------------------------------------------
  # emptyDir Configuration (ephemeral storage)
  # --------------------------------------------------------------------------
  emptyDir:
    # Maximum size of the ephemeral volume
    sizeLimit: "20Gi"
    # Use memory-backed storage for faster access (consumes RAM)
    medium: ""  # Set to "Memory" for tmpfs

  # --------------------------------------------------------------------------
  # PVC Configuration (persistent, shareable storage)
  # --------------------------------------------------------------------------
  # Recommended for production: supports ReadWriteMany (NFS/EFS) for shared cache
  # --------------------------------------------------------------------------
  pvc:
    # Use an existing PVC (if set, chart won't create one)
    existingClaim: ""

    # Storage class (leave empty for cluster default)
    # Examples: "gp3" (AWS EBS), "efs-sc" (AWS EFS), "standard" (GKE), "nfs"
    storageClassName: ""

    # Access modes - ReadWriteMany recommended for shared model cache
    # - ReadWriteOnce: Single node read-write (EBS, standard PD)
    # - ReadOnlyMany: Multi-node read-only (after initial populate)
    # - ReadWriteMany: Multi-node read-write (NFS, EFS, Azure Files)
    accessModes:
      - ReadWriteMany

    # Requested storage size
    size: "50Gi"

    # Volume binding mode annotations (optional)
    annotations: {}

    # Selector for binding to specific PVs (optional)
    selector: {}

  # --------------------------------------------------------------------------
  # HostPath Configuration (node-local caching)
  # --------------------------------------------------------------------------
  # Fastest option but requires:
  # 1. Node affinity to pin pods to nodes with cached models
  # 2. File integrity verification (init container checks hash)
  # --------------------------------------------------------------------------
  hostPath:
    # Path on the host node for model cache
    path: "/var/cache/densecore-models"

    # Type: DirectoryOrCreate (creates if missing), Directory (must exist)
    type: "DirectoryOrCreate"

    # Enable SHA256 verification of cached model files
    # Init container will re-download if hash mismatches
    verifyIntegrity: true

    # Expected SHA256 hash of the model file (optional)
    # Leave empty to skip verification (first download sets baseline)
    expectedSha256: ""

# =============================================================================
# Autoscaling Configuration
# =============================================================================
# Choose between:
#   enabled: false       - Use fixed replicaCount
#   type: "hpa"          - Standard CPU/Memory-based HPA
#   type: "keda"         - Queue/Prometheus-based KEDA scaling
# =============================================================================
autoscaling:
  # Set to false to disable autoscaling entirely
  enabled: true

  # Autoscaler type: "hpa" or "keda"
  type: "hpa"

  # Common settings for all autoscaler types
  minReplicas: 1
  maxReplicas: 10

  # ==========================================================================
  # HPA-specific configuration (used when type: "hpa")
  # ==========================================================================
  hpa:
    # CPU utilization target (percentage)
    cpuTargetUtilization: 70
    # Memory utilization target (percentage)
    memoryTargetUtilization: 80
    # Scale-down stabilization window (seconds)
    scaleDownStabilizationSeconds: 300
    # Scale-down rate limit (percentage per minute)
    scaleDownPercentPerMinute: 10
    # Scale-up stabilization window (seconds)
    scaleUpStabilizationSeconds: 0
    # Maximum pods to add per scale-up event
    scaleUpMaxPods: 4

  # ==========================================================================
  # KEDA-specific configuration (used when type: "keda")
  # ==========================================================================
  keda:
    # Enable KEDA ScaledObject (set to true to disable HPA and use KEDA instead)
    enabled: false

    # Prometheus server address
    prometheusServerAddress: "http://prometheus-server.monitoring.svc.cluster.local:80"

    # Polling interval for metrics (seconds)
    pollingInterval: 15

    # Cooldown period before scale-down (seconds)
    cooldownPeriod: 60

    # Scale-down stabilization window (seconds)
    scaleDownStabilizationSeconds: 120

    # Triggers configuration
    triggers:
      pendingRequests:
        enabled: true
        # Target pending requests per replica
        threshold: "5"
        # PromQL query template (uses release labels automatically)
        # Available template variables: {{ .Release.Name }}, {{ include "densecore.fullname" . }}
        query: 'sum(densecore_pending_requests{app="{{ .Release.Name }}"}) or vector(0)'

      activeRequests:
        enabled: true
        # Target active requests per replica
        threshold: "8"
        query: 'sum(densecore_active_requests{app="{{ .Release.Name }}"}) or vector(0)'

# =============================================================================
# Service Configuration
# =============================================================================
service:
  type: ClusterIP
  port: 80
  targetPort: 8080

# =============================================================================
# Ingress Configuration
# =============================================================================
ingress:
  enabled: false
  className: ""
  annotations: {}
  hosts:
    - host: densecore.local
      paths:
        - path: /
          pathType: Prefix
  tls: []

# =============================================================================
# Resource Requests/Limits
# =============================================================================
resources:
  requests:
    cpu: "2"
    memory: "4Gi"
  limits:
    cpu: "8"
    memory: "16Gi"

# =============================================================================
# Probes Configuration
# =============================================================================
probes:
  liveness:
    path: /health/live
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  readiness:
    path: /health/ready
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  startup:
    path: /health/startup
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 5
    failureThreshold: 60

# =============================================================================
# Security Context
# =============================================================================
securityContext: {}

# =============================================================================
# Node Affinity & Anti-Affinity
# =============================================================================
affinity:
  # Prefer compute-optimized nodes
  nodeAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
            - key: instance-type
              operator: In
              values:
                - compute-optimized
                - cpu-optimized
  # Spread pods across nodes
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: densecore
          topologyKey: kubernetes.io/hostname

# =============================================================================
# Prometheus Monitoring
# =============================================================================
serviceMonitor:
  enabled: false
  interval: 15s
  scrapeTimeout: 10s

# =============================================================================
# Secrets Reference (must be created separately)
# =============================================================================
# kubectl create secret generic densecore-secrets \
#   --from-literal=API_KEYS="sk-key:user:tier" \
#   --from-literal=HF_TOKEN="hf_xxx"
secrets:
  name: densecore-secrets
